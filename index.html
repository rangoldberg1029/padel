<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Padel Buddy – אפליקציית פאדל</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a"/>
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    /* Basic utility helpers (no @apply to ensure Tailwind via CDN works) */
    .btn { padding: 0.4rem 0.8rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; background:#f8fafc; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background:#4f46e5; color:#fff; border-color:#4f46e5; }
    .btn-danger { background:#e11d48; color:#fff; border-color:#e11d48; }
    .btn-ghost { background:#ffffff; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 20px -10px rgba(2,8,23,.2); padding:1rem; }
    .field { border:1px solid #cbd5e1; border-radius:.5rem; padding:.4rem .5rem; }
    .tag { font-size:.75rem; padding:.2rem .5rem; border-radius:999px; background:#eff6ff; color:#0369a1; border:1px solid #bae6fd; }
    .grid2 { display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media(min-width: 640px) { .grid2 { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 to-slate-100">
  <div id="root"></div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("./service-worker.js");
          reg.update?.();
          navigator.serviceWorker.addEventListener("controllerchange", ()=> location.reload());
        } catch(e) { console.log("SW register error", e); }
      });
    }
  </script>

  <script type="text/babel">
    const {useState, useEffect, useMemo} = React;
    const firebaseConfig = {"apiKey": "AIzaSyC57SCpJgj8OuYilKfGslweGX1eePRKzZE", "authDomain": "padel-e5ab0.firebaseapp.com", "projectId": "padel-e5ab0", "storageBucket": "padel-e5ab0.appspot.com", "messagingSenderId": "1028798475012", "appId": "1:1028798475012:web:9d1ce68bf1e3018de9be51", "measurementId": "G-EC2YCTZ36S"};
    const fbApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const toast = (msg)=>{ const el=document.createElement('div'); el.textContent=msg; el.style.cssText='position:fixed;bottom:16px;right:16px;background:#111827cc;color:#fff;padding:8px 12px;border-radius:12px;font-size:12px;z-index:9999'; document.body.appendChild(el); setTimeout(()=>el.remove(),2200); };

    function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function weekNumber(date){const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));const dayNum=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-dayNum);const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil(((d-yearStart)/86400000+1)/7);}
    function pairKey(a,b){if(!a||!b)return"";return [a,b].sort((x,y)=>x.localeCompare(y,'he')).join(" & ");}
    function todayStr(){const d=new Date();return d.toISOString().slice(0,10);}
    function niceName(u){ if(!u) return "אורח"; if(u.displayName) return u.displayName.split(" ")[0]; if(u.email) return u.email.split("@")[0]; return "חבר"; }

    async function setPlayers(list){
      const batch=db.batch();
      const coll=db.collection("players");
      const existing=await coll.get();
      existing.forEach(doc=> batch.delete(doc.ref));
      list.forEach((name, idx)=>{ const ref = coll.doc(); batch.set(ref, { name, idx }); });
      await batch.commit();
    }

    function App(){
      const [tab, setTab] = useState('record');
      const [players, setPlayersState] = useState(["שחקן 1","שחקן 2","שחקן 3","שחקן 4","שחקן 5"]);
      const [playersLoaded, setPlayersLoaded] = useState(false);
      const [err, setErr] = useState("");
      const [user, setUser] = useState(null);
      const [busy, setBusy] = useState(false);

      React.useEffect(()=> auth.onAuthStateChanged(setUser), []);
      const signIn = () => auth.signInWithRedirect(provider);
      const signOut = () => auth.signOut();

      // realtime players
      useEffect(()=>{
        const unsub = db.collection("players").orderBy("idx").onSnapshot(
          snap=>{
            if(!snap.empty){ const arr = snap.docs.map(d=> d.data().name); setPlayersState(arr); setPlayersLoaded(true); }
            else { setPlayers(["שחקן 1","שחקן 2","שחקן 3","שחקן 4","שחקן 5"]).then(()=> setPlayersLoaded(true)); }
          },
          e=>{ console.error("players onSnapshot error", e); setErr(e.message||String(e)); }
        );
        return ()=>unsub();
      }, []);

      const updatePlayer = (idx, name)=>{ const arr = [...players]; arr[idx] = name; setPlayersState(arr); };
      const savePlayers = async()=>{ try { await setPlayers(players); toast("נשמר"); } catch(e){ alert("שגיאת שמירת שחקנים: "+(e.message||e)); } };

      // attendance & draw
      const [attendance, setAttendance] = useState(()=> Object.fromEntries(players.map(p=>[p,true])));
      useEffect(()=>{ const next={}; players.forEach(p=> next[p]=attendance[p] ?? true); setAttendance(next); }, [players.join("|")]);
      const todaysPlayers = useMemo(()=> players.filter(p=>attendance[p]), [players, attendance]);
      const [draw, setDraw] = useState({});
      const runDraw = ()=>{ const present = todaysPlayers.filter(Boolean); if(present.length < 4){ alert("צריך לפחות 4 שחקנים"); return; } const s = shuffle(present);
        if(s.length === 4){ setDraw({ A1:s[0], A2:s[1], B1:s[2], B2:s[3] }); }
        else if(s.length === 5){ setDraw({ A1:s[0], A2:s[1], B1:s[2], B2:s[3], bench:s[4] }); }
        else { setDraw({ A1:s[0], A2:s[1], B1:s[2], B2:s[3], bench:s[4] }); }
      };

      // sessions
      const [currentSessionId, setCurrentSessionId] = useState("");
      const [sessions, setSessions] = useState([]);

      useEffect(()=>{
        const unsub = db.collection("sessions").orderBy("date","desc").onSnapshot(
          snap=>{ const arr = snap.docs.map(d=> ({id:d.id, ...d.data()})); setSessions(arr); if(!currentSessionId && arr.length) setCurrentSessionId(arr[0].id); },
          e=>{ console.error("sessions onSnapshot error", e); setErr(e.message||String(e)); }
        );
        return ()=>unsub();
      }, []);

      const ensureSession = async ()=>{
        const today = todayStr();
        // If a session for today already exists, reuse it
        const existing = sessions.find(s=>s.date===today);
        if(existing){ setCurrentSessionId(existing.id); toast("כבר קיים סשן להיום – בחרתי אותו ✅"); return existing.id; }
        // Otherwise create
        const ref = await db.collection("sessions").add({ date: today, label: `מפגש ${today}` });
        setCurrentSessionId(ref.id);
        toast("נוצר סשן חדש ✅");
        return ref.id;
      };

      const renameSession = async (s)=>{
        const label = prompt("שם חדש למפגש:", s.label || ("מפגש " + s.date));
        if(!label) return;
        await db.collection("sessions").doc(s.id).update({label});
        toast("עודכן");
      };

      const deleteSession = async (s)=>{
        if(!confirm("למחוק את המפגש הזה ואת כל המשחקים של אותו היום?")) return;
        // delete by sessionId
        const q1 = await db.collection("matches").where("sessionId","==",s.id).get();
        // delete by date (matches from same day even if sessionId different)
        const q2 = await db.collection("matches").where("date","==",s.date).get();
        /* placeholder removed */
      };
  </script>
</body>
</html>
